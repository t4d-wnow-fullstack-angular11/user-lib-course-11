!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/common"),require("@angular/core"),require("@angular/forms"),require("@angular/common/http"),require("@angular/material/list"),require("@angular/material/toolbar"),require("@angular/material/sidenav"),require("@angular/material/icon"),require("@angular/material/card"),require("@angular/material/button"),require("@angular/material/form-field"),require("@angular/material/input"),require("@angular/material/menu"),require("@angular/material/table"),require("@angular/material/snack-bar"),require("@ngrx/store"),require("@ngrx/effects"),require("@t4d-wnow/shared-lib"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("lodash-es")):"function"==typeof define&&define.amd?define("@t4d-wnow/user-lib",["exports","@angular/common","@angular/core","@angular/forms","@angular/common/http","@angular/material/list","@angular/material/toolbar","@angular/material/sidenav","@angular/material/icon","@angular/material/card","@angular/material/button","@angular/material/form-field","@angular/material/input","@angular/material/menu","@angular/material/table","@angular/material/snack-bar","@ngrx/store","@ngrx/effects","@t4d-wnow/shared-lib","@angular/router","rxjs","rxjs/operators","lodash-es"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self)["t4d-wnow"]=e["t4d-wnow"]||{},e["t4d-wnow"]["user-lib"]={}),e.ng.common,e.ng.core,e.ng.forms,e.ng.common.http,e.ng.material.list,e.ng.material.toolbar,e.ng.material.sidenav,e.ng.material.icon,e.ng.material.card,e.ng.material.button,e.ng.material.formField,e.ng.material.input,e.ng.material.menu,e.ng.material.table,e.ng.material.snackBar,e["ngrx-store"],e["ngrx-effects"],e["t4d-wnow-shared-lib"],e.ng.router,e.rxjs,e.rxjs.operators,e["lodash-es"])}(this,(function(e,r,t,n,o,a,i,s,u,l,c,m,d,p,f,g,h,v,b,y,w,P,U){"use strict";var M=function(){function e(e){this.fb=e,this.changePassword=new t.EventEmitter}return e.prototype.ngOnInit=function(){this.changePasswordForm=this.fb.group({currentPassword:"",newPassword:"",confirmPassword:""},{validators:[b.confirmValue("newPassword","confirmPassword")]})},e.prototype.doChangePassword=function(){this.changePasswordForm.valid&&this.changePassword.emit(this.changePasswordForm.value)},e}();M.decorators=[{type:t.Component,args:[{selector:"app-change-password-form",template:'<form class="change-password-form" [formGroup]="changePasswordForm">\n\n  <div class="mat-error error" *ngIf="changePasswordForm?.errors?.confirmValue">\n    <mat-icon aria-hidden="false" aria-label="Error">error</mat-icon>\n    The new password and the confirm password do not match.\n  </div>\n\n  <div class="form-field">\n    <mat-form-field appearance="outline">\n      <mat-label>Current Password</mat-label>\n      <input matInput type="password" formControlName="currentPassword">\n    </mat-form-field>\n  </div>\n\n  <div class="form-field">\n    <mat-form-field appearance="outline">\n      <mat-label>New Password</mat-label>\n      <input matInput type="password" formControlName="newPassword">\n    </mat-form-field>\n  </div>\n\n  <div class="form-field">\n    <mat-form-field appearance="outline">\n      <mat-label>Confirm Password</mat-label>\n      <input matInput type="password" formControlName="confirmPassword">\n    </mat-form-field>\n  </div>\n\n  <div class="buttons">\n    <button type="button" (click)="doChangePassword()" mat-raised-button color="primary">\n      Change Password\n    </button>\n  </div>\n\n\n</form>',styles:[".error{padding:10px;text-align:center}.error mat-icon{vertical-align:middle}.buttons,.form-field{text-align:center}.buttons>button{margin:4px}"]}]}],M.ctorParameters=function(){return[{type:n.FormBuilder}]},M.propDecorators={changePassword:[{type:t.Output}]};var C=function(){function e(e,r,t){this.username=e,this.userKind=r,this.displayName=t,this.roles=[]}return e.prototype.addRole=function(e){if(!e)throw new Error("role name cannot be empty");return this.roles.push(e),this},e.prototype.hasRole=function(e){return U.intersection(this.roles,e).length>0},e}(),k=function(){function e(e){this.httpClient=e,this.accessToken=null,this.currentUser=null}return e.prototype.loginEmployee=function(e,r){var t=this;return this.httpClient.post("/api/users/login",{username:e,password:r,kind:"employee"}).pipe(P.tap((function(e){t.accessToken=e.accessToken,localStorage.refreshToken=e.refreshToken})),P.map((function(e){var r=new C(e.username,e.userKind,e.displayName);return e.roles.forEach((function(e){return r.addRole(e)})),r})),P.tap((function(e){t.currentUser=e})))},e.prototype.refreshUser=function(){var e=this;return this.httpClient.get("/api/users/refresh").pipe(P.tap((function(r){e.accessToken=r.accessToken,localStorage.refreshToken=r.refreshToken})),P.map((function(){return w.of(!0)})))},e.prototype.changePassword=function(e,r,t,n){return this.httpClient.post("/api/users/change-password",{username:e,userKind:r,oldPassword:t,newPassword:n})},e.prototype.getCurrentUser=function(){return this.currentUser},e.prototype.getAccessToken=function(){return this.accessToken},e.prototype.getRefreshToken=function(){return localStorage.refreshToken},e.prototype.logoutUser=function(){this.accessToken=null,this.currentUser=null,localStorage.refreshToken=null},e}();k.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new k(t.ɵɵinject(o.HttpClient))},token:k,providedIn:"root"}),k.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],k.ctorParameters=function(){return[{type:o.HttpClient}]};var I=function(){function e(e,r){this.router=e,this.usersSvc=r}return Object.defineProperty(e.prototype,"loggedIn",{get:function(){return!!this.usersSvc.getCurrentUser()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"displayName",{get:function(){var e,r;return null!==(r=null===(e=this.usersSvc.getCurrentUser())||void 0===e?void 0:e.displayName)&&void 0!==r?r:""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"username",{get:function(){var e,r;return null!==(r=null===(e=this.usersSvc.getCurrentUser())||void 0===e?void 0:e.username)&&void 0!==r?r:""},enumerable:!1,configurable:!0}),e.prototype.ngOnInit=function(){},e.prototype.navigateToProfile=function(){return this.router.navigateByUrl("/profile")},e.prototype.navigateToLogout=function(){return this.router.navigateByUrl("/logout")},e.prototype.navigateToLogin=function(){return this.router.navigateByUrl("/login")},e}();I.decorators=[{type:t.Component,args:[{selector:"app-current-user",template:'<div *ngIf="loggedIn">\n  <button mat-button [matMenuTriggerFor]="menu">\n    <mat-icon aria-hidden="false" aria-label="User Account">account_circle</mat-icon>\n    <span>{{displayName}} ({{username}})</span>\n  </button>\n  <mat-menu #menu="matMenu">\n    <button mat-menu-item (click)="navigateToProfile()">Profile</button>\n    <button mat-menu-item (click)="navigateToLogout()">Logout</button>\n  </mat-menu>\n</div>\n<div *ngIf="!loggedIn">\n  <button mat-button (click)="navigateToLogin()">\n    <mat-icon aria-hidden="false" aria-label="User Account">account_circle</mat-icon>\n    <span>Login</span>\n  </button>\n</div>',styles:["mat-icon{margin-right:4px}"]}]}],I.ctorParameters=function(){return[{type:y.Router},{type:k}]};var T=function(){function e(e){this.fb=e,this.loginFormSubmitted=!1,this.login=new t.EventEmitter,this.clear=new t.EventEmitter}return Object.defineProperty(e.prototype,"showLoginFormValidationSummary",{get:function(){return this.loginForm.invalid&&this.loginFormSubmitted},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"showUsernameError",{get:function(){return this.loginForm.get("username").invalid},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"showPasswordError",{get:function(){return this.loginForm.get("password").invalid},enumerable:!1,configurable:!0}),e.prototype.ngOnInit=function(){this.loginForm=this.fb.group({username:["adodsworth",{validators:[n.Validators.required]}],password:["testpass",{validators:[n.Validators.required]}]})},e.prototype.doLogin=function(){this.loginFormSubmitted=!0,this.loginForm.invalid||this.login.emit(this.loginForm.value)},e.prototype.doClear=function(){this.loginForm.reset(),this.clear.emit()},e}();T.decorators=[{type:t.Component,args:[{selector:"app-login-form",template:'<mat-card class="validation-summary-card" *ngIf="showLoginFormValidationSummary">\n  <mat-card-header class="validation-summary-header">\n    <mat-card-title class="validation-summary-title">\n      Errors\n    </mat-card-title>\n  </mat-card-header>\n  <mat-card-content>\n    <mat-list role="list" dense>\n      <mat-list-item role="listitem" *ngIf="showUsernameError">\n        <mat-icon mat-list-icon>arrow_right</mat-icon>\n        Username is required.\n      </mat-list-item>\n      <mat-list-item role="listitem" *ngIf="showPasswordError">\n        <mat-icon mat-list-icon>arrow_right</mat-icon>\n        Password is required.\n      </mat-list-item>\n    </mat-list>\n  </mat-card-content>\n</mat-card>\n\n\n<form class="login-form" [formGroup]="loginForm" (submit)="doLogin()">\n\n  <div class="form-field">\n    <mat-form-field appearance="outline">\n      <mat-label>Username</mat-label>\n      <input matInput formControlName="username" />\n      <mat-error *ngIf="showUsernameError">Username is required</mat-error>\n    </mat-form-field>\n  </div>\n\n  <div class="form-field">\n    <mat-form-field appearance="outline">\n      <mat-label>Password</mat-label>\n      <input matInput formControlName="password" />\n      <mat-error *ngIf="showPasswordError">Password is required</mat-error>\n    </mat-form-field>\n  </div>\n\n  <div class="buttons">\n    <button type="submit" mat-raised-button color="primary">Login</button>\n    <button type="reset" mat-raised-button (click)="doClear()">Clear</button>\n  </div>\n\n</form>',styles:[".buttons,.form-field{padding:6px 0;text-align:center}.buttons>button{margin:4px}.validation-summary-card{margin:0 auto 20px;max-width:400px;padding:0}.validation-summary-header{background-color:#3f51b5;color:#fff}.validation-summary-title{font-size:1.1rem;margin:0;padding:12px}.mat-card-content{padding:8px 0}.mat-list-base[dense] .mat-list-item.mat-list-item-with-avatar,.mat-list-base[dense] .mat-list-option.mat-list-item-with-avatar{height:32px}.mat-list-base[dense] .mat-list-item{font-size:.9rem}"]}]}],T.ctorParameters=function(){return[{type:n.FormBuilder}]},T.propDecorators={login:[{type:t.Output}],clear:[{type:t.Output}]};var S=function(){function e(){this.userProfile=null}return e.prototype.ngOnInit=function(){},e}();S.decorators=[{type:t.Component,args:[{selector:"app-user-profile",template:"<div>\n  <div>Username: {{userProfile?.username}}</div>\n  <div>Display Name: {{userProfile?.displayName}}</div>\n  <div>Roles: {{userProfile?.roles?.join(', ')}}</div>\n</div>",styles:[""]}]}],S.ctorParameters=function(){return[]},S.propDecorators={userProfile:[{type:t.Input}]};var x=h.createAction("[UserLib] Set Current User",h.props()),E=h.createAction("[UserLib] Clear Current User"),F=h.createAction("[UserLib] Login User",h.props()),j=h.createAction("[UserLib] Logout User"),q={},L=h.createReducer(q,h.on(x,(function(e,r){return r.currentUser})),h.on(E,(function(){return{}}))),A=function(e,r){var t=this;this.actions$=e,this.usersSvc=r,this.logoutUser$=v.createEffect((function(){return t.actions$.pipe(v.ofType("[UserLib] Logout User"),P.mergeMap((function(){return w.of(b.clearErrorMessage(),E())})))})),this.loginUser$=v.createEffect((function(){return t.actions$.pipe(v.ofType("[UserLib] Login User"),P.exhaustMap((function(e){return t.usersSvc.loginEmployee(e.username,e.password).pipe(P.mergeMap((function(){return w.of(x({currentUser:t.usersSvc.getCurrentUser()}),b.clearErrorMessage())})),P.catchError((function(e){return 404===e.status?w.of(b.setErrorMessage({errorMessage:"Username and password not found."}),E()):w.of(b.setErrorMessage({errorMessage:"Unknown login error."}),E())})))})))}))};A.decorators=[{type:t.Injectable}],A.ctorParameters=function(){return[{type:v.Actions},{type:k}]};var R=h.StoreModule.forFeature("user",{currentUser:L}),B=v.EffectsModule.forFeature([A]),N=function(){};N.decorators=[{type:t.NgModule,args:[{declarations:[M,I,T,S],imports:[r.CommonModule,n.ReactiveFormsModule,o.HttpClientModule,a.MatListModule,i.MatToolbarModule,s.MatSidenavModule,c.MatButtonModule,u.MatIconModule,l.MatCardModule,m.MatFormFieldModule,d.MatInputModule,p.MatMenuModule,f.MatTableModule,g.MatSnackBarModule,R,B],exports:[M,I,T,S]}]}];var O=function(e){return e.user.currentUser},V=function(e){return e},_=h.createSelector(O,V),z=function(){function e(e,r){this.usersSvc=e,this.snackBar=r}return e.prototype.canActivate=function(e,r){var t;if(null===(t=this.usersSvc.getCurrentUser())||void 0===t?void 0:t.hasRole(e.data.roles))return!0;var n=this.snackBar.open("You are not allowed to navigate to the "+e.data.title+".","Dismiss");return n.onAction().subscribe((function(){n.dismiss()})),!1},e}();z.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new z(t.ɵɵinject(k),t.ɵɵinject(g.MatSnackBar))},token:z,providedIn:"root"}),z.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],z.ctorParameters=function(){return[{type:k},{type:g.MatSnackBar}]};var D=function(){function e(e){this.usersSvc=e}return e.prototype.withAccessToken=function(e){return e.clone({headers:e.headers.set("Authorization","Bearer "+this.usersSvc.getAccessToken())})},e.prototype.withRefreshToken=function(e){return e.clone({method:"GET",headers:e.headers.set("Authorization","Bearer "+this.usersSvc.getRefreshToken())})},e.prototype.intercept=function(e,r){var t=this;return e.url.endsWith("/api/users/login")?r.handle(e):e.url.endsWith("/api/users/refresh")?r.handle(this.withRefreshToken(e)):r.handle(this.withAccessToken(e)).pipe(P.catchError((function(n,a){return n instanceof o.HttpErrorResponse?401===n.status?t.usersSvc.refreshUser().pipe(P.switchMap((function(){return r.handle(t.withAccessToken(e))}))):w.throwError(n):a})))},e}();D.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new D(t.ɵɵinject(k))},token:D,providedIn:"root"}),D.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],D.ctorParameters=function(){return[{type:k}]};var G=function(){function e(e,r){this.usersSvc=e,this.router=r}return e.prototype.canActivate=function(e,r){return!!this.usersSvc.getCurrentUser()||this.router.parseUrl("/login")},e}();G.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new G(t.ɵɵinject(k),t.ɵɵinject(y.Router))},token:G,providedIn:"root"}),G.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],G.ctorParameters=function(){return[{type:k},{type:y.Router}]},e.AllowedRolesGuardService=z,e.AuthorizationInterceptorService=D,e.ChangePasswordFormComponent=M,e.CurrentUser=C,e.CurrentUserComponent=I,e.EffectsFeatureModule=B,e.LoggedInGuardService=G,e.LoginFormComponent=T,e.StoreFeatureModule=R,e.UserLibModule=N,e.UserProfileComponent=S,e.UsersService=k,e.clearCurrentUser=E,e.loginUser=F,e.logoutUser=j,e.selectCurrentUser=_,e.setCurrentUser=x,e.ɵ0=O,e.ɵ1=V,e.ɵa=q,e.ɵb=L,e.ɵc=A,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=t4d-wnow-user-lib.umd.min.js.map